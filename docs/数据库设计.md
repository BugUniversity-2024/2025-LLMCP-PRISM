# PRISM 数据库设计文档

> 版本：v1.0
>
> 最后更新：2026-01-03

---

## 一、概述

PRISM 项目采用轻量级的 SQLite 关系数据库，使用 SQLAlchemy 2.0 作为 ORM 框架，Alembic 进行数据库版本管理。

**设计原则**：
- **简洁性**：仅 2 张核心表，避免过度设计
- **可扩展性**：支持版本树结构，未来可扩展为 DAG（有向无环图）
- **性能优化**：合理设计索引，加速常用查询
- **数据完整性**：外键约束 + 级联操作保证数据一致性

---

## 二、ER 图（实体关系图）

### 2.1 文字描述版

```
┌─────────────────────────┐
│       Sessions          │  项目/会话表
│      （项目表）          │
├─────────────────────────┤
│ • id (PK)               │  UUID 主键
│ • name                  │  项目名称
│ • description           │  项目描述
│ • created_at            │  创建时间
│ • updated_at            │  更新时间
└───────────┬─────────────┘
            │
            │ 1:N（一对多）
            │ 一个项目有多个版本
            │
┌───────────▼─────────────┐
│       Versions          │  版本表
│      （版本表）          │
├─────────────────────────┤
│ • id (PK)               │  UUID 主键
│ • session_id (FK)       │  所属项目 ID ──┐
│ • version_number        │  版本号（1,2,3...）│
│ • parent_version_id (FK)│  父版本 ID ◄────┼─ 自关联
│ • user_input            │  用户创意输入    │  （版本树）
│ • user_feedback         │  用户反馈       │
│ • schema (JSON)         │  结构化 Schema  │
│ • prompt (Text)         │  自然语言 Prompt │
│ • diff (JSON)           │  Prompt Diff    │
│ • image_url             │  图片访问 URL    │
│ • image_path            │  图片本地路径    │
│ • created_at            │  创建时间       │
└─────────────────────────┘
```

### 2.2 ASCII 艺术版 ER 图

```
    Sessions (项目表)                 Versions (版本表)
   ┌────────────────┐                ┌──────────────────────┐
   │ id (PK)        │────┐           │ id (PK)              │
   │ name           │    │           │ session_id (FK) ◄────┼───┐
   │ description    │    │           │ version_number       │   │
   │ created_at     │    │           │ parent_version_id(FK)│◄──┼─┐
   │ updated_at     │    │           │ user_input           │   │ │
   └────────────────┘    │           │ user_feedback        │   │ │
                         │           │ schema (JSON)        │   │ │
                         │           │ prompt (Text)        │   │ │
                    1:N 关系          │ diff (JSON)          │   │ │
                         │           │ image_url            │   │ │
                         │           │ image_path           │   │ │
                         │           │ created_at           │   │ │
                         │           └──────────────────────┘   │ │
                         │                    │                 │ │
                         └────────────────────┘                 │ │
                                                                 │ │
                                     自关联（版本树结构）         │ │
                                                                 └─┘
```

### 2.3 关系说明

| 关系类型 | 说明 | 约束 |
|---------|------|------|
| Sessions → Versions | **一对多**：一个项目可以有多个版本 | CASCADE DELETE（删除项目时删除所有版本） |
| Versions → Versions | **自关联**：版本可以有父版本（支持版本树） | SET NULL（删除父版本时保留子版本） |

---

## 三、表结构详细设计

### 3.1 Sessions 表（会话/项目表）

**表名**：`sessions`

**用途**：存储用户创建的项目/会话信息，每个项目是一个独立的创作单元。

#### 字段定义

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| `id` | String | 36 | PRIMARY KEY | UUID | 主键，使用 UUID v4 |
| `name` | String | 255 | NULLABLE | "未命名项目" | 项目名称 |
| `description` | Text | - | NULLABLE | NULL | 项目描述（可选） |
| `created_at` | DateTime | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间（UTC） |
| `updated_at` | DateTime | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间（UTC，自动更新） |

#### ORM 代码（SQLAlchemy）

```python
from sqlalchemy import Column, String, Text, DateTime
from sqlalchemy.orm import relationship
from datetime import datetime
from uuid import uuid4

class Session(Base):
    """会话表"""
    __tablename__ = "sessions"

    id = Column(String(36), primary_key=True, default=lambda: str(uuid4()))
    name = Column(String(255), nullable=True, default="未命名项目")
    description = Column(Text, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)

    # 关系：一个 Session 有多个 Versions
    versions = relationship("Version", back_populates="session", cascade="all, delete-orphan")
```

#### 索引设计

| 索引名 | 字段 | 类型 | 说明 |
|--------|------|------|------|
| PRIMARY | `id` | PRIMARY KEY | 主键索引（自动创建） |

---

### 3.2 Versions 表（版本表）

**表名**：`versions`

**用途**：存储每次 Prompt 优化和图片生成的版本记录，支持版本树结构。

#### 字段定义

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| `id` | String | 36 | PRIMARY KEY | UUID | 主键，使用 UUID v4 |
| `session_id` | String | 36 | FOREIGN KEY, NOT NULL | - | 所属项目 ID → sessions.id |
| `version_number` | Integer | - | NOT NULL | - | 版本号（1, 2, 3...） |
| `parent_version_id` | String | 36 | FOREIGN KEY, NULLABLE | NULL | 父版本 ID → versions.id（支持版本树） |
| `user_input` | Text | - | NULLABLE | NULL | 用户创意输入（仅 v1 版本有） |
| `user_feedback` | Text | - | NULLABLE | NULL | 用户反馈（v2+ 版本有） |
| `schema` | JSON | - | NOT NULL | - | 结构化 Prompt Schema（JSON 格式） |
| `prompt` | Text | - | NOT NULL | - | 自然语言 Prompt |
| `diff` | JSON | - | NULLABLE | NULL | Prompt Diff（v2+ 版本有，记录与父版本的差异） |
| `image_url` | String | 500 | NOT NULL | - | 图片访问 URL（用于前端展示） |
| `image_path` | String | 500 | NOT NULL | - | 图片本地路径（服务器存储路径） |
| `created_at` | DateTime | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间（UTC） |

#### 字段说明

##### 1. `session_id`（外键）
- 指向 `sessions.id`
- 删除策略：`ON DELETE CASCADE`（删除项目时，级联删除所有版本）

##### 2. `parent_version_id`（自关联外键）
- 指向 `versions.id`（同表的另一行）
- 删除策略：`ON DELETE SET NULL`（删除父版本时，子版本保留，但父版本 ID 置空）
- **版本树示例**：
  ```
  v1 (parent_version_id = NULL)
   ├─ v2 (parent_version_id = v1.id)
   │   └─ v4 (parent_version_id = v2.id)
   └─ v3 (parent_version_id = v1.id)
  ```

##### 3. `user_input` vs `user_feedback`
- **v1 版本**：`user_input` 有值（用户的初始创意），`user_feedback` 为 NULL
- **v2+ 版本**：`user_feedback` 有值（用户对上一版本的反馈），`user_input` 为 NULL

##### 4. `schema`（JSON 字段）
结构化的 Prompt 数据，示例：
```json
{
  "subject": "狐狸娘",
  "appearance": ["兽耳", "狐狸尾巴", "柔顺长发"],
  "style": "二次元插画",
  "lighting": "柔和自然光",
  "composition": "半身特写",
  "atmosphere": "温馨可爱",
  "details": "细腻的毛发质感",
  "quality": "高清，精细",
  "weights": {
    "style_strength": 0.7,
    "realism": 0.5
  }
}
```

##### 5. `diff`（JSON 字段）
Prompt Diff 记录（仅 v2+ 版本有），示例：
```json
{
  "operations": [
    {
      "action": "add",
      "field": "appearance",
      "values": ["自然肤色"],
      "reasoning": "用户反馈脸部色彩诡异"
    },
    {
      "action": "adjust",
      "field": "weights.realism",
      "delta": 0.2,
      "reasoning": "降低 AI 风格"
    }
  ]
}
```

##### 6. `image_url` vs `image_path`
- **image_url**：前端访问地址，例如 `http://localhost:8000/images/abc123.png`
- **image_path**：后端文件系统路径，例如 `/storage/abc123.png`

#### ORM 代码（SQLAlchemy）

```python
from sqlalchemy import Column, String, Integer, Text, DateTime, JSON, ForeignKey, Index
from sqlalchemy.orm import relationship
from datetime import datetime
from uuid import uuid4

class Version(Base):
    """版本表"""
    __tablename__ = "versions"

    id = Column(String(36), primary_key=True, default=lambda: str(uuid4()))
    session_id = Column(String(36), ForeignKey("sessions.id", ondelete="CASCADE"), nullable=False)
    version_number = Column(Integer, nullable=False)
    parent_version_id = Column(String(36), ForeignKey("versions.id", ondelete="SET NULL"), nullable=True)

    # 用户输入
    user_input = Column(Text, nullable=True)
    user_feedback = Column(Text, nullable=True)

    # Prompt 数据
    schema = Column(JSON, nullable=False)
    prompt = Column(Text, nullable=False)
    diff = Column(JSON, nullable=True)

    # 图片数据
    image_url = Column(String(500), nullable=False)
    image_path = Column(String(500), nullable=False)

    # 元数据
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # 关系：多对一（版本属于一个项目）
    session = relationship("Session", back_populates="versions")

    # 自关联：版本树
    parent_version = relationship("Version", remote_side=[id], backref="children")

    # 索引
    __table_args__ = (
        Index("idx_session_versions", "session_id", "version_number"),
        Index("idx_parent_version", "parent_version_id"),
        Index("idx_created_at", "created_at"),
    )
```

#### 索引设计

| 索引名 | 字段 | 类型 | 用途 |
|--------|------|------|------|
| PRIMARY | `id` | PRIMARY KEY | 主键索引（自动创建） |
| `idx_session_versions` | `(session_id, version_number)` | COMPOSITE | 加速"获取某项目的所有版本"查询 |
| `idx_parent_version` | `parent_version_id` | SINGLE | 加速版本树遍历（获取子版本） |
| `idx_created_at` | `created_at` | SINGLE | 加速按时间排序的查询 |

**索引分析**：
- **idx_session_versions**：最常用查询是"获取项目的版本列表"，复合索引 `(session_id, version_number)` 可直接覆盖查询
- **idx_parent_version**：支持版本树遍历，如"获取某版本的所有子版本"
- **idx_created_at**：支持按时间排序，如"最近生成的版本"

---

## 四、数据流转说明

### 4.1 创建新项目 + 生成 v1

```sql
-- 1. 插入新项目
INSERT INTO sessions (id, name, description, created_at, updated_at)
VALUES ('uuid-1', '狐狸娘主题', NULL, NOW(), NOW());

-- 2. 插入 v1 版本
INSERT INTO versions (
    id, session_id, version_number, parent_version_id,
    user_input, user_feedback,
    schema, prompt, diff,
    image_url, image_path, created_at
)
VALUES (
    'uuid-v1', 'uuid-1', 1, NULL,  -- parent_version_id = NULL（根节点）
    '画一只二次元狐狸娘', NULL,     -- 有 user_input，无 user_feedback
    '{"subject": "狐狸娘", ...}',   -- 结构化 Schema
    '一位可爱的狐狸娘...',          -- 自然语言 Prompt
    NULL,                            -- 无 diff
    'http://.../v1.png', '/storage/v1.png',
    NOW()
);
```

### 4.2 反馈优化，生成 v2

```sql
-- 插入 v2 版本
INSERT INTO versions (
    id, session_id, version_number, parent_version_id,
    user_input, user_feedback,
    schema, prompt, diff,
    image_url, image_path, created_at
)
VALUES (
    'uuid-v2', 'uuid-1', 2, 'uuid-v1',  -- parent_version_id = v1.id
    NULL, 'AI 味道太重，脸部色彩诡异',  -- 有 user_feedback，无 user_input
    '{"subject": "狐狸娘", ...}',       -- 优化后的 Schema
    '一位可爱的狐狸娘，自然肤色...',    -- 优化后的 Prompt
    '{"operations": [...]}',             -- 有 diff
    'http://.../v2.png', '/storage/v2.png',
    NOW()
);
```

### 4.3 查询项目的版本历史

```sql
SELECT
    v.version_number,
    v.user_input,
    v.user_feedback,
    v.prompt,
    v.image_url,
    v.created_at
FROM versions v
WHERE v.session_id = 'uuid-1'
ORDER BY v.version_number ASC;
```

**结果**：
| version_number | user_input | user_feedback | prompt | image_url | created_at |
|---------------|-----------|---------------|--------|-----------|------------|
| 1 | 画一只二次元狐狸娘 | NULL | 一位可爱的狐狸娘... | http://.../v1.png | 2026-01-01 10:00 |
| 2 | NULL | AI 味道太重 | 一位可爱的狐狸娘，自然肤色... | http://.../v2.png | 2026-01-01 10:05 |

### 4.4 查询版本树（获取子版本）

```sql
-- 获取 v1 的所有直接子版本
SELECT *
FROM versions
WHERE parent_version_id = 'uuid-v1';

-- 递归查询整棵版本树（需要数据库支持 CTE）
WITH RECURSIVE version_tree AS (
    -- 根节点
    SELECT * FROM versions WHERE id = 'uuid-v1'
    UNION ALL
    -- 递归获取子节点
    SELECT v.* FROM versions v
    INNER JOIN version_tree vt ON v.parent_version_id = vt.id
)
SELECT * FROM version_tree;
```

---

## 五、数据库迁移

### 5.1 Alembic 配置

**工具**：Alembic（SQLAlchemy 的数据库迁移工具）

**配置文件位置**：
- `backend/alembic.ini` - Alembic 配置
- `backend/alembic/env.py` - 环境配置
- `backend/alembic/versions/` - 迁移脚本目录

### 5.2 已完成的迁移

#### 迁移 1：初始化 Schema

**文件**：`4a4901b52e0a_initial_schema_for_sqlite.py`

**时间**：2024-12-30

**内容**：
- 创建 `sessions` 表
- 创建 `versions` 表
- 创建外键约束
- 创建索引

**关键代码**：
```python
def upgrade():
    op.create_table('sessions',
        sa.Column('id', sa.String(36), primary_key=True),
        sa.Column('created_at', sa.DateTime(), nullable=False),
        sa.Column('updated_at', sa.DateTime(), nullable=False),
    )

    op.create_table('versions',
        sa.Column('id', sa.String(36), primary_key=True),
        sa.Column('session_id', sa.String(36), nullable=False),
        sa.Column('version_number', sa.Integer(), nullable=False),
        # ... 其他字段
        sa.ForeignKeyConstraint(['session_id'], ['sessions.id'], ondelete='CASCADE'),
        sa.ForeignKeyConstraint(['parent_version_id'], ['versions.id'], ondelete='SET NULL'),
    )

    # 创建索引
    op.create_index('idx_session_versions', 'versions', ['session_id', 'version_number'])
    op.create_index('idx_parent_version', 'versions', ['parent_version_id'])
    op.create_index('idx_created_at', 'versions', ['created_at'])
```

#### 迁移 2：添加项目元数据字段

**文件**：`0ce629caf52d_add_name_and_description_to_sessions.py`

**时间**：2024-12-30

**内容**：
- 为 `sessions` 表添加 `name` 字段
- 为 `sessions` 表添加 `description` 字段

**关键代码**：
```python
def upgrade():
    with op.batch_alter_table('sessions', schema=None) as batch_op:
        batch_op.add_column(sa.Column('name', sa.String(255), nullable=True, default='未命名项目'))
        batch_op.add_column(sa.Column('description', sa.Text(), nullable=True))
```

### 5.3 迁移命令

```bash
# 生成新迁移文件
uv run alembic revision --autogenerate -m "描述信息"

# 应用迁移（升级到最新版本）
uv run alembic upgrade head

# 查看迁移历史
uv run alembic history

# 回滚到上一个版本
uv run alembic downgrade -1
```

---

## 六、性能优化

### 6.1 索引优化策略

| 查询场景 | 使用的索引 | 性能 |
|---------|-----------|------|
| 获取项目的版本列表 | `idx_session_versions` | O(log N) |
| 获取某版本的子版本 | `idx_parent_version` | O(log N) |
| 按时间排序版本 | `idx_created_at` | O(log N) |
| 通过 ID 查询版本 | PRIMARY KEY | O(1) |

### 6.2 数据量估算

**假设**：
- 平均每个项目 10 个版本
- 100 个项目

**总数据量**：
- Sessions 表：100 行
- Versions 表：1000 行

**存储估算**：
- 每行约 2KB（包含 JSON 字段）
- 总存储：~2MB

**性能评估**：SQLite 在百万级别数据量下性能良好，当前数据规模完全无压力。

### 6.3 未来优化方向

当数据量增长到 10 万+ 版本时，可考虑：
1. **分区**：按时间分区（SQLite 不支持，需迁移到 PostgreSQL）
2. **归档**：旧版本迁移到冷存储
3. **缓存**：使用 Redis 缓存热点数据

---

## 七、数据完整性保证

### 7.1 外键约束

| 外键 | 引用 | 删除策略 | 说明 |
|-----|------|---------|------|
| `versions.session_id` → `sessions.id` | CASCADE | 删除项目时，级联删除所有版本 | 保证不会出现孤儿版本 |
| `versions.parent_version_id` → `versions.id` | SET NULL | 删除父版本时，子版本的 parent_version_id 置空 | 允许删除中间节点，保留子孙节点 |

### 7.2 数据验证

在应用层（FastAPI + Pydantic）进行数据验证：
- `version_number` 必须 >= 1
- `schema` 必须符合 JSON Schema 格式
- `image_url` 和 `image_path` 必须非空

### 7.3 事务管理

关键操作使用事务保证原子性：
```python
from sqlalchemy.orm import Session

with Session() as session:
    # 开启事务
    session.add(new_session)
    session.add(new_version)
    session.commit()  # 提交事务
```

---

## 八、附录

### 8.1 完整的 DDL（SQLite）

```sql
-- 创建 Sessions 表
CREATE TABLE sessions (
    id TEXT(36) PRIMARY KEY,
    name TEXT(255) DEFAULT '未命名项目',
    description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 创建 Versions 表
CREATE TABLE versions (
    id TEXT(36) PRIMARY KEY,
    session_id TEXT(36) NOT NULL,
    version_number INTEGER NOT NULL,
    parent_version_id TEXT(36),
    user_input TEXT,
    user_feedback TEXT,
    schema TEXT NOT NULL,  -- JSON 存储为 TEXT
    prompt TEXT NOT NULL,
    diff TEXT,             -- JSON 存储为 TEXT
    image_url TEXT(500) NOT NULL,
    image_path TEXT(500) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_version_id) REFERENCES versions(id) ON DELETE SET NULL
);

-- 创建索引
CREATE INDEX idx_session_versions ON versions(session_id, version_number);
CREATE INDEX idx_parent_version ON versions(parent_version_id);
CREATE INDEX idx_created_at ON versions(created_at);
```

### 8.2 示例数据

```sql
-- 插入示例项目
INSERT INTO sessions VALUES
('s1', '狐狸娘主题', '尝试生成二次元狐狸娘', '2026-01-01 10:00:00', '2026-01-01 10:10:00');

-- 插入示例版本
INSERT INTO versions VALUES
('v1', 's1', 1, NULL, '画一只二次元狐狸娘', NULL,
 '{"subject": "狐狸娘", "style": "二次元插画"}',
 '一位可爱的狐狸娘，兽耳，狐狸尾巴...',
 NULL,
 'http://localhost:8000/images/v1.png',
 '/storage/v1.png',
 '2026-01-01 10:00:00');

INSERT INTO versions VALUES
('v2', 's1', 2, 'v1', NULL, 'AI 味道太重',
 '{"subject": "狐狸娘", "style": "二次元插画", "appearance": ["自然肤色"]}',
 '一位可爱的狐狸娘，兽耳，狐狸尾巴，自然肤色...',
 '{"operations": [{"action": "add", "field": "appearance", "values": ["自然肤色"]}]}',
 'http://localhost:8000/images/v2.png',
 '/storage/v2.png',
 '2026-01-01 10:05:00');
```

---

**文档编写日期**：2026-01-03

**编写者**：AptS:1548（AI 助手）+ AptS:1547（审核）

# PRISM 系统架构说明

> 版本：v1.0
>
> 最后更新：2026-01-03

---

## 一、整体架构图

```
                                PRISM 系统架构
                        （前后端分离 + LLM 集成）

┌─────────────────────────────────────────────────────────────────────┐
│                          用户层 (User Layer)                         │
│                                                                       │
│  ┌──────────────┐          ┌──────────────┐          ┌──────────────┐│
│  │  Web Browser │          │   Chrome     │          │   Firefox    ││
│  └──────────────┘          └──────────────┘          └──────────────┘│
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                │ HTTPS (localhost:5173)
                                │
┌───────────────────────────────▼─────────────────────────────────────┐
│                      前端层 (Frontend Layer)                         │
│                      Vue 3 + TypeScript + Vite                       │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      视图层 (Views)                           │  │
│  │  ┌───────────────────────────────────────────────────────┐   │  │
│  │  │   Home.vue - 主页面（三栏布局）                       │   │  │
│  │  │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │  │
│  │  │   │ 左侧面板    │ │ 中间面板    │ │ 右侧面板    │    │   │  │
│  │  │   │ InputPanel  │ │ImageViewer │ │PromptDetails│    │   │  │
│  │  │   │ProjectList  │ │ Lightbox    │ │             │    │   │  │
│  │  │   └─────────────┘ └─────────────┘ └─────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                   状态管理层 (Store Layer)                    │  │
│  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │  │
│  │  │ sessionStore │    │ versionStore │    │  uiStore     │   │  │
│  │  │ (Pinia)      │    │  (Pinia)     │    │  (Pinia)     │   │  │
│  │  └──────────────┘    └──────────────┘    └──────────────┘   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                   API 调用层 (API Layer)                      │  │
│  │  ┌──────────────────────────────────────────────────────┐   │  │
│  │  │ api/client.ts - Axios 封装                            │   │  │
│  │  │ api/sessions.ts - 项目管理 API                        │   │  │
│  │  │ api/generate.ts - 生成 API                            │   │  │
│  │  │ api/feedback.ts - 反馈 API                            │   │  │
│  │  └──────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                │ HTTP REST API (JSON)
                                │ localhost:8000/api/v1
                                │
┌───────────────────────────────▼─────────────────────────────────────┐
│                      后端层 (Backend Layer)                          │
│                      FastAPI + Python 3.11                           │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                   API 路由层 (API Router Layer)               │  │
│  │  ┌──────────────────────────────────────────────────────┐   │  │
│  │  │ /api/v1/generate    - POST 生成图片                  │   │  │
│  │  │ /api/v1/sessions/{id}/feedback - POST 提交反馈       │   │  │
│  │  │ /api/v1/sessions    - GET 获取项目列表               │   │  │
│  │  │ /api/v1/sessions/{id} - GET/PUT/DELETE 项目管理      │   │  │
│  │  │ /api/v1/sessions/{id}/versions - GET 获取版本历史    │   │  │
│  │  │ /images/{filename}  - GET 静态图片访问               │   │  │
│  │  │ /docs               - GET Swagger UI                 │   │  │
│  │  └──────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                ↓                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                 业务逻辑层 (Service Layer)                    │  │
│  │  ┌─────────────────────────────────────────────────────┐    │  │
│  │  │ PromptEngine (services/prompt_engine.py)            │    │  │
│  │  │ • 接收用户输入                                        │    │  │
│  │  │ • 调用 GPT-4o + System Prompt                       │    │  │
│  │  │ • 生成结构化 Schema                                   │    │  │
│  │  │ • 转换为自然语言 Prompt                               │    │  │
│  │  └─────────────────────────────────────────────────────┘    │  │
│  │                                                                │  │
│  │  ┌─────────────────────────────────────────────────────┐    │  │
│  │  │ FeedbackEngine (services/feedback_engine.py)        │    │  │
│  │  │ • 接收用户反馈                                        │    │  │
│  │  │ • 调用 GPT-4o + Feedback Prompt                     │    │  │
│  │  │ • 生成 Prompt Diff                                   │    │  │
│  │  │ • 应用 Diff 到 Schema                                │    │  │
│  │  └─────────────────────────────────────────────────────┘    │  │
│  │                                                                │  │
│  │  ┌─────────────────────────────────────────────────────┐    │  │
│  │  │ ImageAdapter (services/image_adapter.py)            │    │  │
│  │  │ • 调用火山引擎 Seedream API                           │    │  │
│  │  │ • 下载图片到本地存储                                   │    │  │
│  │  │ • 返回图片 URL 和路径                                 │    │  │
│  │  └─────────────────────────────────────────────────────┘    │  │
│  │                                                                │  │
│  │  ┌─────────────────────────────────────────────────────┐    │  │
│  │  │ SessionManager (services/session_manager.py)        │    │  │
│  │  │ • 项目 CRUD 操作                                      │    │  │
│  │  │ • 版本管理                                            │    │  │
│  │  └─────────────────────────────────────────────────────┘    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                ↓                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                 数据访问层 (Data Access Layer)                │  │
│  │  ┌─────────────────────────────────────────────────────┐    │  │
│  │  │ SQLAlchemy ORM                                       │    │  │
│  │  │ • models/session.py - Session/Version 模型           │    │  │
│  │  │ • core/database.py - 数据库连接                       │    │  │
│  │  │ • Alembic 迁移管理                                    │    │  │
│  │  └─────────────────────────────────────────────────────┘    │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────┬────────────────┬────────────────────────┘
                            │                │
                            │                │
                    ┌───────▼────────┐   ┌──▼──────────┐
                    │  SQLite 数据库  │   │ File System │
                    │  (sessions,     │   │  (图片存储) │
                    │   versions)     │   │  /storage/  │
                    └────────────────┘   └─────────────┘

                    ┌────────────────────────────────────┐
                    │      外部服务层 (External APIs)     │
                    ├────────────────────────────────────┤
                    │                                     │
                    │  ┌──────────────────────────────┐ │
                    │  │     OpenAI API (GPT-4o)      │ │
                    │  │  • Prompt 优化               │ │
                    │  │  • 反馈分析                  │ │
                    │  │  • 支持第三方中转             │ │
                    │  └──────────────────────────────┘ │
                    │                                     │
                    │  ┌──────────────────────────────┐ │
                    │  │  火山引擎 Seedream API       │ │
                    │  │  • 图片生成                  │ │
                    │  │  • 使用 OpenAI SDK 兼容接口  │ │
                    │  └──────────────────────────────┘ │
                    └────────────────────────────────────┘
```

---

## 二、核心流程图

### 2.1 首次生成流程

```
┌──────────────────────────────────────────────────────────────┐
│  用户在前端输入创意："画一只二次元狐狸娘"                      │
└──────────────────────┬───────────────────────────────────────┘
                       │
                       │ POST /api/v1/generate
                       │ { user_input: "画一只二次元狐狸娘", session_id: null }
                       ▼
┌────────────────────────────────────────────────────────────┐
│  后端 API 路由层 (/api/v1/generate)                        │
│  • 验证请求参数（Pydantic Schema）                          │
│  • 调用 PromptEngine.generate()                            │
└──────────────────────┬─────────────────────────────────────┘
                       │
                       ▼
┌────────────────────────────────────────────────────────────┐
│  PromptEngine.generate()                                   │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 1. 读取 System Prompt (generation.txt)               │ │
│  │ 2. 调用 OpenAI API (GPT-4o)                          │ │
│  │    Request: {                                         │ │
│  │      model: "gpt-4o",                                 │ │
│  │      messages: [                                      │ │
│  │        {role: "system", content: generation_prompt}, │ │
│  │        {role: "user", content: "画一只二次元狐狸娘"}  │ │
│  │      ]                                                │ │
│  │    }                                                  │ │
│  │ 3. 解析返回的结构化 Schema (JSON)                     │ │
│  │ 4. Schema → 自然语言 Prompt (火山风格)                │ │
│  └──────────────────────────────────────────────────────┘ │
└──────────────────────┬─────────────────────────────────────┘
                       │
                       │ 返回 { schema, prompt, preview: true }
                       ▼
┌────────────────────────────────────────────────────────────┐
│  前端展示 Prompt 预览                                       │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 优化后的 Prompt:                                      │ │
│  │ "一位可爱的狐狸娘，兽耳，狐狸尾巴，柔顺长发，         │ │
│  │  二次元插画风格，柔和自然光..."                        │ │
│  │                                                       │ │
│  │ [确认生成]  [修改 Prompt]                             │ │
│  └──────────────────────────────────────────────────────┘ │
└──────────────────────┬─────────────────────────────────────┘
                       │
                       │ 用户点击 [确认生成]
                       │ POST /api/v1/generate
                       │ { confirm: true, schema: {...}, prompt: "..." }
                       ▼
┌────────────────────────────────────────────────────────────┐
│  ImageAdapter.generate()                                   │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 1. 调用火山引擎 Seedream API                          │ │
│  │    client.images.generate(                            │ │
│  │      model="doubao-seedream-4-0-250828",             │ │
│  │      prompt="...",                                    │ │
│  │      size="2K"                                        │ │
│  │    )                                                  │ │
│  │ 2. 下载图片到本地 /storage/xxx.png                    │ │
│  │ 3. 生成访问 URL: http://localhost:8000/images/xxx.png│ │
│  └──────────────────────────────────────────────────────┘ │
└──────────────────────┬─────────────────────────────────────┘
                       │
                       ▼
┌────────────────────────────────────────────────────────────┐
│  保存到数据库                                               │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 1. 创建 Session 记录（项目）                          │ │
│  │    INSERT INTO sessions (id, name, ...)               │ │
│  │ 2. 创建 Version v1 记录                               │ │
│  │    INSERT INTO versions (                             │ │
│  │      session_id, version_number=1,                    │ │
│  │      user_input="画一只二次元狐狸娘",                  │ │
│  │      schema={...}, prompt="...",                      │ │
│  │      image_url="...", image_path="..."               │ │
│  │    )                                                  │ │
│  └──────────────────────────────────────────────────────┘ │
└──────────────────────┬─────────────────────────────────────┘
                       │
                       │ 返回 { version_id, image_url, ... }
                       ▼
┌────────────────────────────────────────────────────────────┐
│  前端展示生成结果                                           │
│  • 图片展示在中间面板（ImageViewer）                        │
│  • Prompt 详情显示在右侧（PromptDetails）                   │
│  • 版本历史添加 v1（VersionList）                           │
└────────────────────────────────────────────────────────────┘
```

### 2.2 反馈迭代流程

```
┌──────────────────────────────────────────────────────────────┐
│  用户对 v1 不满意，提交反馈："AI 味道太重，脸部色彩诡异"      │
└──────────────────────┬───────────────────────────────────────┘
                       │
                       │ POST /api/v1/sessions/{id}/feedback
                       │ { feedback: "AI 味道太重...", current_version: 1 }
                       ▼
┌────────────────────────────────────────────────────────────┐
│  FeedbackEngine.analyze()                                  │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 1. 从数据库获取 v1 的 Schema                          │ │
│  │ 2. 读取 System Prompt (feedback.txt)                 │ │
│  │ 3. 调用 OpenAI API (GPT-4o)                          │ │
│  │    Request: {                                         │ │
│  │      model: "gpt-4o",                                 │ │
│  │      messages: [                                      │ │
│  │        {role: "system", content: feedback_prompt},   │ │
│  │        {role: "user", content: 包含 v1_schema + 反馈} │ │
│  │      ]                                                │ │
│  │    }                                                  │ │
│  │ 4. 解析返回的 Prompt Diff (JSON)                      │ │
│  │    {                                                  │ │
│  │      operations: [                                    │ │
│  │        { action: "add", field: "appearance", ...},   │ │
│  │        { action: "adjust", field: "weights", ...}    │ │
│  │      ]                                                │ │
│  │    }                                                  │ │
│  │ 5. 应用 Diff: v1_schema + diff → v2_schema           │ │
│  └──────────────────────────────────────────────────────┘ │
└──────────────────────┬─────────────────────────────────────┘
                       │
                       │ 返回 { schema_v2, prompt_v2, diff, preview: true }
                       ▼
┌────────────────────────────────────────────────────────────┐
│  前端展示优化后的 Prompt 预览                               │
│  • 用户确认后，调用 ImageAdapter.generate() 生成新图片      │
│  • 保存 v2 到数据库（包含 parent_version_id 和 diff）      │
│  • 前端展示新图片和版本对比                                  │
└────────────────────────────────────────────────────────────┘
```

---

## 三、关键技术点说明

### 3.1 前端技术栈

#### Vue 3 Composition API
```typescript
// 示例：使用 Composition API 管理状态
import { ref, computed } from 'vue'
import { useSessionStore } from '@/stores/session'

const sessionStore = useSessionStore()
const currentVersion = computed(() => sessionStore.currentVersion)
const generateImage = async () => {
  await sessionStore.generate(userInput.value)
}
```

#### Pinia 状态管理
```typescript
// stores/session.ts
export const useSessionStore = defineStore('session', () => {
  const sessions = ref<Session[]>([])
  const currentSession = ref<Session | null>(null)

  async function fetchSessions() {
    sessions.value = await api.sessions.list()
  }

  return { sessions, currentSession, fetchSessions }
})
```

#### Tailwind CSS v4
```vue
<!-- 使用 Tailwind v4 的新特性 -->
<div class="bg-gradient-to-br from-blue-50 to-purple-50 backdrop-blur-sm">
  <h1 class="text-2xl font-bold animate-fade-in">PRISM</h1>
</div>
```

### 3.2 后端技术栈

#### FastAPI 路由定义
```python
from fastapi import APIRouter, Depends
from app.schemas.generate import GenerateRequest, GenerateResponse

router = APIRouter(prefix="/api/v1", tags=["generation"])

@router.post("/generate", response_model=GenerateResponse)
async def generate_image(
    request: GenerateRequest,
    session: Session = Depends(get_db)
):
    result = await prompt_engine.generate(request.user_input)
    return result
```

#### SQLAlchemy 2.0 ORM
```python
from sqlalchemy import select
from app.models.session import Session, Version

# 使用新式查询语法
async def get_versions(session_id: str):
    stmt = select(Version).where(
        Version.session_id == session_id
    ).order_by(Version.version_number)
    result = await session.execute(stmt)
    return result.scalars().all()
```

#### Alembic 迁移
```python
# alembic/versions/xxx_add_field.py
def upgrade():
    op.add_column('sessions', sa.Column('name', sa.String(255)))

def downgrade():
    op.drop_column('sessions', 'name')
```

### 3.3 LLM 集成

#### OpenAI SDK 调用
```python
from openai import OpenAI

client = OpenAI(
    api_key=settings.OPENAI_API_KEY,
    base_url=settings.OPENAI_API_BASE  # 支持第三方中转
)

response = client.chat.completions.create(
    model="gpt-4o",
    messages=[
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_input}
    ],
    response_format={"type": "json_object"}
)
```

#### 火山引擎 Seedream
```python
# 使用 OpenAI SDK 兼容接口
client = OpenAI(
    api_key=settings.ARK_API_KEY,
    base_url="https://ark.cn-beijing.volces.com/api/v3"
)

image_response = client.images.generate(
    model="doubao-seedream-4-0-250828",
    prompt=optimized_prompt,
    size="2K",
    response_format="url"
)
```

---

## 四、数据流转说明

### 4.1 请求流转

```
用户浏览器
    ↓ HTTP Request (localhost:5173)
Vue Router (前端路由)
    ↓ API 调用 (Axios)
Nginx / 开发服务器 (代理到 :8000)
    ↓ HTTP Request (localhost:8000/api/v1)
FastAPI 路由层 (main.py + api/v1/)
    ↓ 参数验证 (Pydantic)
业务逻辑层 (services/)
    ↓ ORM 查询 (SQLAlchemy)
数据库层 (SQLite) 或 外部 API (GPT-4o / Seedream)
    ↓ 返回数据
逐层返回到前端
```

### 4.2 状态管理

**前端状态**：
- **sessionStore**：当前项目、项目列表
- **versionStore**：当前版本、版本历史
- **uiStore**：加载状态、错误提示

**后端状态**：
- **数据库持久化**：Sessions + Versions
- **文件系统**：生成的图片存储在 `/storage/`

---

## 五、部署架构（可选扩展）

### 5.1 开发环境

```
┌─────────────┐      ┌─────────────┐
│ Frontend    │      │ Backend     │
│ Vite Dev    │ ───▶ │ uvicorn     │
│ :5173       │      │ :8000       │
└─────────────┘      └──────┬──────┘
                            │
                            ▼
                     ┌─────────────┐
                     │ SQLite DB   │
                     │ (本地文件)   │
                     └─────────────┘
```

### 5.2 生产环境（建议）

```
               ┌──────────────────────┐
               │  Nginx / Caddy       │
               │  (反向代理 + HTTPS)   │
               └───────┬──────────────┘
                       │
         ┌─────────────┴──────────────┐
         │                             │
    ┌────▼────┐                  ┌────▼────┐
    │ Frontend │                  │ Backend │
    │ Nginx    │                  │ FastAPI │
    │ (静态)   │                  │ Gunicorn│
    └──────────┘                  └────┬────┘
                                       │
                              ┌────────┴────────┐
                              │                  │
                         ┌────▼────┐      ┌─────▼─────┐
                         │ SQLite  │      │  Storage  │
                         │ (或 PG) │      │  (图片)    │
                         └─────────┘      └───────────┘
```

---

## 六、性能优化要点

### 6.1 前端优化
- **代码分割**：Vue Router 懒加载
- **资源压缩**：Vite 自动压缩
- **图片懒加载**：IntersectionObserver

### 6.2 后端优化
- **数据库索引**：已创建 3 个关键索引
- **连接池**：SQLAlchemy 连接池管理
- **异步 IO**：FastAPI 原生异步支持

### 6.3 API 优化
- **Prompt 预览**：避免无效图片生成
- **错误重试**：3 次重试 + 降级 Mock
- **缓存（未实现）**：可引入 Redis 缓存热点数据

---

## 七、安全性设计

### 7.1 API 密钥管理
- ✅ 使用 `.env` 文件存储，不提交到 Git
- ✅ `.env.example` 提供模板

### 7.2 数据验证
- ✅ Pydantic Schema 验证所有请求参数
- ✅ SQL 注入防护（SQLAlchemy ORM）

### 7.3 文件上传（未实现）
- 如果支持用户上传图片，需添加：
  - 文件类型白名单
  - 文件大小限制
  - 病毒扫描

---

## 八、监控与日志（可扩展）

### 8.1 日志记录
```python
import logging

logger = logging.getLogger(__name__)
logger.info(f"Generated prompt for session {session_id}")
logger.error(f"Failed to call LLM API: {error}")
```

### 8.2 性能监控
- **前端**：可集成 Sentry 监控错误
- **后端**：可使用 Prometheus + Grafana 监控 API 性能

---

**文档编写日期**：2026-01-03

**编写者**：全员协作
